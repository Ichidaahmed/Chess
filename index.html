<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة شطرنج المحترفين</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboard2@0.5.0/dist/chessboard2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboard2@0.5.0/dist/chessboard2.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-light: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text-main: #ffffff;
        }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: var(--bg-light);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1, h2, h3 { text-align: center; margin-bottom: 20px; color: var(--highlight); }

        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* تنسيق الأزرار والإدخال */
        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            color: white;
            background-color: var(--accent);
        }
        .btn:hover { background-color: #1a5c9e; transform: scale(1.02); }
        .btn-danger { background-color: var(--highlight); }
        .btn-danger:hover { background-color: #c0354c; }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid var(--accent);
            background: #0f3460;
            color: white;
            font-size: 1rem;
            text-align: center;
        }

        /* خيارات الوقت */
        .time-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .time-option {
            background: var(--bg-dark);
            border: 2px solid var(--accent);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .time-option.selected {
            background: var(--highlight);
            border-color: var(--highlight);
        }
        
        .time-option i { display: block; font-size: 1.5rem; margin-bottom: 5px; }

        /* لوحة الشطرنج */
        #board {
            width: 100%;
            margin: 20px 0;
            border: 5px solid #4a4a4a;
            border-radius: 4px;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .timer {
            font-family: 'Courier New', monospace;
            font-size: 1.5rem;
            font-weight: bold;
            background: black;
            color: red;
            padding: 5px 15px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        .turn-indicator {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
        }
        .turn-white { background: #f0d9b5; color: black; }
        .turn-black { background: #b58863; color: white; }

        .room-code-box {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
            border: 2px dashed var(--highlight);
        }
        .room-code {
            font-family: monospace;
            font-size: 2rem;
            letter-spacing: 5px;
            color: var(--highlight);
            display: block;
            margin: 10px 0;
        }

    </style>
</head>
<body>

<div class="container">
    
    <div id="setup-page" class="page active">
        <h1><i class="fas fa-chess-knight"></i> شطرنج المحترفين</h1>
        
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3>أنشئ مباراة جديدة</h3>
            <label>اختر نظام الوقت:</label>
            <div class="time-options">
                <div class="time-option selected" onclick="selectTime(1)" id="t-1">
                    <i class="fas fa-bolt"></i>
                    1 دقيقة (Bullet)
                </div>
                <div class="time-option" onclick="selectTime(5)" id="t-5">
                    <i class="fas fa-stopwatch"></i>
                    5 دقائق (Blitz)
                </div>
                <div class="time-option" onclick="selectTime(10)" id="t-10">
                    <i class="fas fa-clock"></i>
                    10 دقائق (Rapid)
                </div>
                <div class="time-option" onclick="showCustomTime()" id="t-custom">
                    <i class="fas fa-cog"></i>
                    وقت مخصص
                </div>
            </div>
            
            <div id="custom-time-input" style="display:none;">
                <input type="number" id="custom-minutes" placeholder="أدخل عدد الدقائق" min="1" max="60">
            </div>

            <button class="btn" onclick="createGame()">إنشاء الغرفة</button>
        </div>

        <div style="border-top: 1px solid #333; padding-top: 20px;">
            <h3>أو انضم لصديق</h3>
            <input type="text" id="join-code" placeholder="أدخل كود الغرفة">
            <button class="btn" onclick="joinGame()">انضمام</button>
        </div>
    </div>

    <div id="waiting-page" class="page">
        <h2>في انتظار الخصم...</h2>
        <div class="room-code-box">
            <span>كود الغرفة:</span>
            <span class="room-code" id="display-code">------</span>
            <button class="btn" onclick="copyCode()" style="font-size: 0.9rem; padding: 5px;">نسخ الكود</button>
        </div>
        <p style="text-align: center;">شارك الكود مع صديقك ليبدأ التحدي!</p>
        <button class="btn btn-danger" onclick="location.reload()">إلغاء</button>
    </div>

    <div id="game-page" class="page">
        <div class="game-header">
            <div class="player-info">
                <i class="fas fa-user"></i> <span id="opponent-name">الخصم</span>
            </div>
            <div class="timer" id="timer-opponent">00:00</div>
        </div>

        <div id="board"></div>

        <div class="game-header">
            <div class="player-info">
                <i class="fas fa-user-circle"></i> <span id="my-name">أنت</span> (<span id="my-color-text"></span>)
            </div>
            <div class="timer" id="timer-self">00:00</div>
        </div>

        <div id="status-message" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
        <button class="btn btn-danger" onclick="leaveGame()">انسحاب / خروج</button>
    </div>

</div>

<script>
    // --- تهيئة Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyBvWGwTwzWztUystFa_PiASBM1_zKYljgE",
        authDomain: "gunter-9588f.firebaseapp.com",
        projectId: "gunter-9588f",
        storageBucket: "gunter-9588f.appspot.com",
        databaseURL: "https://gunter-9588f-default-rtdb.europe-west1.firebasedatabase.app"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- متغيرات اللعبة ---
    let game = new Chess();
    let board = null;
    let roomId = null;
    let myColor = 'white';
    let selectedTime = 1; // الافتراضي دقيقة واحدة
    let timers = { white: 0, black: 0 };
    let timerInterval = null;
    let isGameOver = false;

    // --- منطق اختيار الوقت ---
    function selectTime(minutes) {
        selectedTime = minutes;
        document.querySelectorAll('.time-option').forEach(el => el.classList.remove('selected'));
        document.getElementById('t-' + minutes).classList.add('selected');
        document.getElementById('custom-time-input').style.display = 'none';
    }

    function showCustomTime() {
        document.querySelectorAll('.time-option').forEach(el => el.classList.remove('selected'));
        document.getElementById('t-custom').classList.add('selected');
        document.getElementById('custom-time-input').style.display = 'block';
    }

    // --- إنشاء اللعبة ---
    function createGame() {
        // التحقق من الوقت المخصص
        if (document.getElementById('t-custom').classList.contains('selected')) {
            const customVal = parseInt(document.getElementById('custom-minutes').value);
            if (!customVal || customVal <= 0) return alert('الرجاء إدخال وقت صحيح');
            selectedTime = customVal;
        }

        roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
        myColor = 'white';
        
        const gameData = {
            fen: game.fen(),
            pgn: '',
            turn: 'white',
            timeControl: selectedTime * 60, // تحويل لثواني
            timers: { white: selectedTime * 60, black: selectedTime * 60 },
            lastMoveTime: Date.now(),
            status: 'waiting',
            players: { white: true, black: false }
        };

        db.ref('rooms/' + roomId).set(gameData);
        
        listenToGame();
        
        document.getElementById('display-code').innerText = roomId;
        showPage('waiting-page');
    }

    // --- الانضمام ---
    function joinGame() {
        const code = document.getElementById('join-code').value.toUpperCase().trim();
        if (!code) return alert("أدخل الكود");

        db.ref('rooms/' + code).once('value', snapshot => {
            if (!snapshot.exists()) return alert("الغرفة غير موجودة");
            const data = snapshot.val();
            if (data.players.black) return alert("الغرفة ممتلئة");

            roomId = code;
            myColor = 'black';
            
            // تحديث حالة الغرفة لتبدأ اللعبة
            db.ref('rooms/' + roomId).update({
                'players/black': true,
                'status': 'active',
                'lastMoveTime': Date.now() // بدء حساب الوقت
            });

            listenToGame();
        });
    }

    // --- الاستماع لتحديثات Firebase ---
    function listenToGame() {
        db.ref('rooms/' + roomId).on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;

            // إذا انضم الخصم وأنا في الانتظار
            if (data.status === 'active' && document.getElementById('waiting-page').classList.contains('active')) {
                startGameUI(data);
            }

            // تحديث اللوحة إذا حدثت حركة جديدة من الخصم
            if (game.fen() !== data.fen) {
                game.load(data.fen);
                board.position(data.fen);
                updateStatus(data.turn);
                // تشغيل صوت حركة (اختياري)
            }
            
            // مزامنة الوقت
            timers = data.timers;
            updateTimerDisplay();
        });
    }

    function startGameUI(data) {
        showPage('game-page');
        document.getElementById('my-color-text').innerText = myColor === 'white' ? 'أبيض' : 'أسود';
        document.getElementById('my-color-text').className = myColor === 'white' ? 'turn-white' : 'turn-black';
        
        // إعداد المؤقتات الأولية
        timers = data.timers;
        
        // بدء المؤقت المحلي
        startTimerInterval();

        // إعداد اللوحة
        const config = {
            draggable: true,
            position: 'start',
            orientation: myColor,
            moveSpeed: 'fast', // حركة سلسة وسريعة
            snapbackSpeed: 50,
            snapSpeed: 50,
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: () => board.position(game.fen())
        };
        board = Chessboard2('board', config);
        
        // التعامل مع تغير حجم الشاشة
        window.onresize = board.resize;
    }

    // --- منطق اللعبة (Chess Logic) ---
    
    function onDragStart(source, piece) {
        if (isGameOver) return false;
        // منع تحريك قطع الخصم
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false;
        }
        // منع التحريك إذا لم يكن دورك
        if ((game.turn() === 'w' && myColor === 'black') ||
            (game.turn() === 'b' && myColor === 'white')) {
            return false;
        }
    }

    function onDrop(source, target) {
        // التحقق من قانونية الحركة محلياً أولاً لسرعة الاستجابة
        const move = game.move({
            from: source,
            to: target,
            promotion: 'q' // ترقية تلقائية للوزير للسرعة
        });

        if (move === null) return 'snapback'; // حركة غير قانونية تعود مكانها

        // إذا الحركة صحيحة، أرسلها للسيرفر
        const now = Date.now();
        const timeSpent = Math.floor((now - lastTickTime) / 1000); // حساب تقريبي (السيرفر أدق لكن هذا مؤقت)
        
        // نقوم بتحديث السيرفر
        db.ref('rooms/' + roomId).transaction(currentData => {
            if (currentData) {
                // تحديث وقت اللاعب الذي لعب للتو
                const colorJustPlayed = move.color === 'w' ? 'white' : 'black';
                
                // حساب دقيق للوقت المتبقي بناءً على الفارق الزمني الحقيقي
                const timeDiff = Math.floor((Date.now() - currentData.lastMoveTime) / 1000);
                const newTime = Math.max(0, currentData.timers[colorJustPlayed] - timeDiff);
                
                return {
                    ...currentData,
                    fen: game.fen(),
                    turn: game.turn() === 'w' ? 'white' : 'black',
                    lastMoveTime: Date.now(),
                    timers: {
                        ...currentData.timers,
                        [colorJustPlayed]: newTime
                    }
                };
            }
        });

        updateStatus(game.turn());
    }

    // --- نظام التوقيت ---
    let lastTickTime = Date.now();
    
    function startTimerInterval() {
        if (timerInterval) clearInterval(timerInterval);
        
        timerInterval = setInterval(() => {
            if (isGameOver) return;
            
            // نعرف دور من الآن
            const activeColor = game.turn() === 'w' ? 'white' : 'black';
            
            // نخصم ثانية من اللاعب الحالي محلياً للعرض فقط
            if (timers[activeColor] > 0) {
                timers[activeColor]--;
                updateTimerDisplay();
            } else {
                // انتهى الوقت!
                handleTimeOut(activeColor);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        // تنسيق الوقت MM:SS
        const format = (s) => {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        };

        const myTime = timers[myColor];
        const oppTime = timers[myColor === 'white' ? 'black' : 'white'];
        
        document.getElementById('timer-self').innerText = format(myTime);
        document.getElementById('timer-opponent').innerText = format(oppTime);

        // تنبيه لوني إذا انخفض الوقت
        if (myTime < 10) document.getElementById('timer-self').style.color = 'red';
        else document.getElementById('timer-self').style.color = 'white';
    }

    function handleTimeOut(losingColor) {
        clearInterval(timerInterval);
        isGameOver = true;
        const msg = losingColor === myColor ? "انتهى وقتك! لقد خسرت." : "انتهى وقت الخصم! لقد فزت.";
        document.getElementById('status-message').innerText = msg;
        alert(msg);
    }

    function updateStatus(turn) {
        let status = '';
        if (game.in_checkmate()) {
            status = 'كش مات! انتهت اللعبة.';
            isGameOver = true;
            clearInterval(timerInterval);
        } else if (game.in_draw()) {
            status = 'تعادل!';
            isGameOver = true;
            clearInterval(timerInterval);
        } else {
            if (game.in_check()) status = 'كش ملك!';
            else status = (turn === 'white' ? 'دور الأبيض' : 'دور الأسود');
        }
        document.getElementById('status-message').innerText = status;
    }

    // --- أدوات مساعدة ---
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    function copyCode() {
        navigator.clipboard.writeText(roomId);
        alert("تم نسخ الكود: " + roomId);
    }

    function leaveGame() {
        if(confirm("هل أنت متأكد من الخروج؟")) {
            location.reload();
        }
    }
</script>
</body>
</html>
